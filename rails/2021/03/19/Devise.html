<!DOCTYPE html>
<html lang="en-US">
  <head><div id="endpoint" class="hidden">https://ycchenvictor.github.io</div>
<div id="base" class="hidden">/blog</div>
<!-- 3D drawing -->
    
    <!-- 2D drawing -->
    
    <!-- for mathjax support -->
    
    <!-- mermaid --><meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/blog/assets/css/main.css">
    <script src="https://kit.fontawesome.com/f9271f6bdd.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark-dimmed.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
  </head>

  <body class="font-mono list-disc">
    <div class="pt-12 pb-4">
      
        <nav class="flex flex-wrap items-center justify-center px-2 mb-6">
  <div class="flex">
    <div class="flex absolute left-0 top-0">
      <img class="object-cover mx-auto h-36 w-36 rounded-full" src="/blog/assets/img/title.jpeg"
        alt="author profile image">
    </div>
    <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
      <div class="w-full relative flex justify-center">
        <button type="button" onclick="toggleNavbar('navbar')"
          class="rounded-md inline-flex items-center justify-center text-gray-500 md:hidden"
          aria-expanded="false">
          <span class="sr-only">Open menu</span>
          <!-- Heroicon name: outline/menu -->
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>

      <div class="absolute right-16 flex hidden md:block" id="navbar">
        <div class="flex flex-col md:flex-row mr-auto w-full">
           <!-- don't show Home in menu for Homepage -->
            <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
              href="/blog/">
              Home
            </a>
          

        <!-- dynamic menu based on navigation info in _config.yml -->
        
           <!-- don't show current page in menu -->
            <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
              href="/blog/about">
              About
            </a>
          
        
           <!-- don't show current page in menu -->
            <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
              href="/blog/category">
              Category
            </a>
          
        
        </div>
      </div>
    </div>
  </div>
</nav>

      
      
  <div id="sidebar" class="pt-24 pl-4 fixed"></div>

<div class="p-16 prose prose-indigo">
  <h1 class="text-center mt-6 mb-6">Devise</h1>
  <div class="text-center">
    
  </div>
  <div class="px-72">
    <h2 id="introduction">Introduction</h2>

<p>Devise is a customizable solution for authentication in Rails. It is based on Warden, the framework for authentication in ruby; it has following characteristics:</p>

<ul>
  <li>Rack based</li>
  <li>Complete MVC solution in Rails</li>
  <li>(Key Feature) By adding <code class="language-plaintext highlighter-rouge">:authenticate_user!</code> in controller, user can do various things only when he/she signed in.</li>
  <li>With modularity, we can choose the modules we want <strong>only</strong>
    <ul>
      <li>There are ten modules: Database Authenticatable, Omniauthable, Confirmable, Recoverable, Registerable, Rememberable, Trackablem Timeoutable, Validatable, Lockable (<a href="https://github.com/heartcombo/devise">devise-github</a>)</li>
    </ul>
  </li>
</ul>

<h2 id="why">Why?</h2>

<p>The most popular authentication solution for Rails applications is Devise. The advantages:</p>

<ul>
  <li>time saving; authentication by hand requires multiple controllers and a mass time of setup</li>
  <li>useful helpers</li>
  <li>simple routes settings</li>
</ul>

<h2 id="how">How?</h2>

<p>In the following steps, we are going to add devise to signin and login</p>

<h3 id="add-devise">Add Devise</h3>

<p>In Gemfile, add the following</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem <span class="s1">'devise'</span>
</code></pre></div></div>

<p>After installing, we need the following generator to describe all the setting related to <code class="language-plaintext highlighter-rouge">devise</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate devise:install
</code></pre></div></div>

<p>Then it will create <code class="language-plaintext highlighter-rouge">initializer</code> in app/config and the following message:
<img src="/blog/assets/img/devise_initializer.png" alt="" /></p>

<ul>
  <li>Message 1 (required)</li>
  <li>Message 2 (not required for API-only)</li>
  <li>Message 3 (not required for API-only)</li>
  <li>Message 4 (not required), <code class="language-plaintext highlighter-rouge">rails g devise:views</code> can generate HTML templates for registration, login, forget password, email, which are all in <em>app/views/devise.</em></li>
</ul>

<h3 id="generate-user">Generate User</h3>

<p>Input</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails g devise user
</code></pre></div></div>

<p>to generate User model and Migration. (You can create any model with devise)</p>

<p>Before we do migration, we should go to <code class="language-plaintext highlighter-rouge">db/migrate/_devise_create_users.rb</code> to change the setting. For example, if we want the trackable effect, we can uncomment the lines of code below ##trackable.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# frozen_string_literal: true

class DeviseCreateUsers &lt; ActiveRecord::Migration[6.1]  
  def change  
    create_table :users do |t|  
      ## Database authenticatable  
      t.string :email,              null: false, default: ""  
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable  
      t.string   :reset_password_token  
      t.datetime :reset_password_sent_at

      ## Rememberable  
      t.datetime :remember_created_at

      ## Trackable  
      # t.integer  :sign_in_count, default: 0, null: false  
      # t.datetime :current_sign_in_at  
      # t.datetime :last_sign_in_at  
      # t.string   :current_sign_in_ip  
      # t.string   :last_sign_in_ip

      ## Confirmable  
      # t.string   :confirmation_token  
      # t.datetime :confirmed_at  
      # t.datetime :confirmation_sent_at  
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable  
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts  
      # t.string   :unlock_token # Only if unlock strategy is :email or :both  
      # t.datetime :locked_at

      t.timestamps null: false  
    end

  add_index :users, :email,                unique: true  
    add_index :users, :reset_password_token, unique: true  
    # add_index :users, :confirmation_token,   unique: true  
    # add_index :users, :unlock_token,         unique: true  
  end  
end
</code></pre></div></div>
<p>Then we can do migration <code class="language-plaintext highlighter-rouge">rails db:migrate</code>.</p>

<p>The routes related to devise:
<img src="/blog/assets/img/routes_related_to_devise.png" alt="" /></p>

<p>In <a href="http://127.0.0.1:3000/users/sign_up">http://127.0.0.1:3000/users/sign_up</a>, we should see the following view
<img src="/blog/assets/img/rails_devise_signup.png" alt="" width="400" /></p>

<h3 id="add-authentication">Add authentication</h3>

<p>For example, if I want user to login before any action to a model, we can put</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before_action :authenticate_user!, except: [:index, :show]
</code></pre></div></div>
<p>in that controller.</p>

<h3 id="the-methods-auto-created-bydevise">The methods auto-created by devise</h3>

<p>If the model created by devise is User, then the following methods:</p>

<p><strong>user_signed_in?</strong>: to check whether a user signed in and return true or false.</p>

<p><strong>current_user</strong>: to get the current login user.</p>

<p><strong>user_session</strong>: it returns <code class="language-plaintext highlighter-rouge">warden.session</code> for model User and <code class="language-plaintext highlighter-rouge">warden.session</code> returns <code class="language-plaintext highlighter-rouge">rack.session</code>, which has encoding method and devise used it for authentication.</p>

<p>You can get the source code from <code class="language-plaintext highlighter-rouge">devise/lib/devise/controllers/helpers.rb</code></p>

<h3 id="customization">Customization</h3>

<h4 id="add-two-columns-in-user-model">Add two columns in user model</h4>

<p>For the basic example of <code class="language-plaintext highlighter-rouge">User</code> model, we can add first and last name with</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate migration add_name_to_users name:string surname:string
</code></pre></div></div>

<p>and do migration again. (This step also means that we can do lots of modifications to customize the contents)</p>

<p>Then the view for user signing up</p>

<pre><code class="language-HTML">&lt;h2&gt;Sign up&lt;/h2&gt;

&lt;%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %&gt;
  &lt;%= render "devise/shared/error_messages", resource: resource %&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :email %&gt;&lt;br /&gt;
    &lt;%= f.email_field :email, autofocus: true, autocomplete: "email" %&gt;
  &lt;/div&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :name %&gt;&lt;br /&gt;
    &lt;%= f.text_field :name %&gt;
  &lt;/div&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :surname %&gt;&lt;br /&gt;
    &lt;%= f.text_field :surname %&gt;
  &lt;/div&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :password %&gt;
    &lt;% if @minimum_password_length %&gt;
    &lt;em&gt;(&lt;%= @minimum_password_length %&gt; characters minimum)&lt;/em&gt;
    &lt;% end %&gt;&lt;br /&gt;
    &lt;%= f.password_field :password, autocomplete: "new-password" %&gt;
  &lt;/div&gt;

  &lt;div class="field"&gt;
    &lt;%= f.label :password_confirmation %&gt;&lt;br /&gt;
    &lt;%= f.password_field :password_confirmation, autocomplete: "new-password" %&gt;
  &lt;/div&gt;

  &lt;div class="actions"&gt;
    &lt;%= f.submit "Sign up" %&gt;
  &lt;/div&gt;

&lt;% end %&gt;

&lt;%= render "devise/shared/links" %&gt;
</code></pre>

<p>Then we can do experiment, adding a user with the sign up webpage. In rails console, we should see the following
<img src="/assets/img/1__yH__l67xnLP4ohEnftZ8Pug.png" alt="" /></p>

<p>Notice! There is no name and surname in the database because we need to explicitly tell rails to accept these two fields in the form. As a result, in <code class="language-plaintext highlighter-rouge">app/controllers/application_controller.rb</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ApplicationController &lt; ActionController::Base
  protect_from_forgery with: :exception

  before_action :update_allowed_parameters, if: :devise_controller?

  protected

  def update_allowed_parameters
    devise_parameter_sanitizer.permit(:sign_up) { |u| u.permit(:name, :surname, :email, :password)}
    devise_parameter_sanitizer.permit(:account_update) { |u| u.permit(:name, :surname, :email, :password, :current_password)}
  end
end
</code></pre></div></div>

<p>With method <code class="language-plaintext highlighter-rouge">update_allowed_parameters</code>, it can add name and surname in the database.</p>

<p>Let’s delete the user in rails console with <code class="language-plaintext highlighter-rouge">User.first.delete</code> and sign up again. Then the data we want is successfully input into database.
<img src="/assets/img/1__uPJ4Cvv2NnvZS976d9opqg.png" alt="" /></p>

<h3 id="interlude">interlude</h3>

<p>What if we want to have more actions not just the actions created by devise? (please refer to the routes for the actions) The only conflict lays on the routes because with <code class="language-plaintext highlighter-rouge">devise_for :users</code> and <code class="language-plaintext highlighter-rouge">resources :users</code> there would be same routes and action being used by devise and the method of user controller simultaneously. As a result, we should setup the routes and controller with the action name and path name different from the action name and path name created by devise. For example, the mechanism of follower and followee:</p>

<h4 id="user-controller-elaborate-later">User controller (elaborate later)</h4>

<p><strong>routes</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Rails.application.routes.draw do
  ...
  devise_for :users

  post '/users/:id/follow', to: "users#follow"
  post '/users/:id/unfollow', to: "users#unfollow"
  ...
end
</code></pre></div></div>

<h2 id="what">What?</h2>

<p>Give a real world example</p>

<h2 id="reference">Reference</h2>

<p><a href="https://github.com/heartcombo/devise">heartcombo/devise</a></p>

<p><a href="https://ihower.tw/rails/auth.html">Ruby on Rails 實戰聖經</a></p>

<p><a href="https://hackernoon.com/using-devise-in-your-ruby-on-rails-application-a-step-by-step-guide-m92i3y5s">Using Devise In Your Ruby on Rails Application [A Step-by-Step Guide] Hacker Noon</a></p>

<p><a href="https://github.com/heartcombo/devise/blob/master/lib/devise/controllers/helpers.rb">heartcombo/devise</a></p>

<p><a href="https://ruby-china.org/topics/32842">Warden 的代码学习</a></p>

<p><a href="https://github.com/wardencommunity/warden/blob/master/lib/warden/mixins/common.rb">wardencommunity/warden</a></p>

<p><a href="https://levelup.gitconnected.com/devise-authentication-with-rails-5-815b5a9d6daf">Devise Authentication with Rails 5</a></p>

  </div>
</div>

<footer class="relative px-4 pt-4 pb-4">
  
  <!-- divider -->
  <div class="relative my-8">
    <div class="absolute inset-0 flex items-center" aria-hidden="true">
      <div class="w-full border-t border-gray-200"></div>
    </div>
    <div class="relative flex justify-center ">
      <span class="bg-white px-2 text-gray-200">
        <i class="text-xs far fa-square"></i>
      </span>
    </div>
  </div>

  <!-- footer msg -->
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      © <span id="get-current-year"></span>
      
      <a href="" class="!no-underline">
        
      </a>
      
    </div>
  </div>
  </div>
</footer>

      <button
        type="button"
        data-mdb-ripple="true"
        data-mdb-ripple-color="light"
        class="inline-block p-3 bg-red-600 text-white font-medium text-xs leading-tight uppercase rounded-full shadow-md hover:bg-red-700 hover:shadow-lg focus:bg-red-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-red-800 active:shadow-lg transition duration-150 ease-in-out bottom-5 right-5 fixed"
        id="btn-back-to-top"
      >
        <svg aria-hidden="true" focusable="false" data-prefix="fas" class="w-4 h-4" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg>
      </button>
    </div>
  </body>

  <script>
    /* Function for getting the current year in the footer */
    (function () {
      if (document.getElementById("get-current-year")) {
        document.getElementById(
          "get-current-year"
        ).innerHTML = new Date().getFullYear();
      }
    })();
    /* Function for opening navbar on mobile */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("block");
      }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
      let element = event.target;
      while (element.nodeName !== "A") {
        element = element.parentNode;
      }
      document.getElementById(dropdownID).classList.toggle("hidden");
      document.getElementById(dropdownID).classList.toggle("block");
    }

    // Get the button
    let myButton = document.getElementById("btn-back-to-top");
    // When the user scrolls down 20px from the top of the document, show the button
    window.onscroll = function () {
      scrollFunction();
    };
    function scrollFunction() {
      if (
        document.body.scrollTop > 20 ||
        document.documentElement.scrollTop > 20
      ) {
        myButton.style.display = "block";
      } else {
        myButton.style.display = "none";
      }
    }
    // When the user clicks on the button, scroll to the top of the document
    myButton.addEventListener("click", backToTop);
    function backToTop() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }
  </script>

  <script type="text/javascript" src="/blog/assets/javascripts/bundle.js" charset="utf-8"></script>
</html>
